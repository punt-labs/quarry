AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Quarry SageMaker serverless embedding endpoint.
  Deploys snowflake-arctic-embed-m-v1.5 on a HuggingFace DLC with
  custom CLS-token pooling. Pay-per-request, $0 when idle.

Parameters:
  EndpointName:
    Type: String
    Default: quarry-embedding
    Description: Name for the SageMaker endpoint
  MemorySizeInMB:
    Type: Number
    Default: 3072
    AllowedValues: [1024, 2048, 3072, 4096, 5120, 6144]
    Description: Memory per serverless instance (3072 = minimum for this model)
  MaxConcurrency:
    Type: Number
    Default: 1
    MinValue: 1
    MaxValue: 10
    Description: Max concurrent invocations (1 is fine for batch ingestion)
  ModelDataBucket:
    Type: String
    Description: S3 bucket containing custom inference code (model.tar.gz)
  ModelDataKey:
    Type: String
    Default: sagemaker/quarry-embedding/model.tar.gz
    Description: S3 key for the model.tar.gz

Resources:
  ExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${EndpointName}-execution-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: sagemaker.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerReadOnly
      Policies:
        - PolicyName: SageMakerExecution
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                  - ecr:BatchCheckLayerAvailability
                Resource: "*"
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${ModelDataBucket}"
                  - !Sub "arn:aws:s3:::${ModelDataBucket}/*"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:log-group:/aws/sagemaker/*"

  Model:
    Type: AWS::SageMaker::Model
    Properties:
      ExecutionRoleArn: !GetAtt ExecutionRole.Arn
      PrimaryContainer:
        Image: !Sub "763104351884.dkr.ecr.${AWS::Region}.amazonaws.com/huggingface-pytorch-inference:2.1.0-transformers4.37.0-cpu-py310-ubuntu22.04"
        ModelDataUrl: !Sub "s3://${ModelDataBucket}/${ModelDataKey}"
        Environment:
          HF_MODEL_ID: Snowflake/snowflake-arctic-embed-m-v1.5
          HF_TASK: feature-extraction
          SAGEMAKER_CONTAINER_LOG_LEVEL: "20"

  EndpointConfig:
    Type: AWS::SageMaker::EndpointConfig
    Properties:
      ProductionVariants:
        - ModelName: !GetAtt Model.ModelName
          VariantName: AllTraffic
          ServerlessConfig:
            MemorySizeInMB: !Ref MemorySizeInMB
            MaxConcurrency: !Ref MaxConcurrency

  Endpoint:
    Type: AWS::SageMaker::Endpoint
    Properties:
      EndpointName: !Ref EndpointName
      EndpointConfigName: !GetAtt EndpointConfig.EndpointConfigName

Outputs:
  EndpointName:
    Description: SageMaker endpoint name (set as SAGEMAKER_ENDPOINT_NAME)
    Value: !GetAtt Endpoint.EndpointName
  EndpointArn:
    Description: SageMaker endpoint ARN
    Value: !Ref Endpoint
  ExecutionRoleArn:
    Description: IAM execution role ARN
    Value: !GetAtt ExecutionRole.Arn
  MemorySizeInMB:
    Description: Serverless memory allocation
    Value: !Ref MemorySizeInMB
